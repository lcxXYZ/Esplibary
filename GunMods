--// Combined Gun Mods + Tracer + Viewmodel Script

-- ===== GLOBAL SETTINGS =====
getgenv().Cheat = getgenv().Cheat or {}
getgenv().Cheat.Options = getgenv().Cheat.Options or {}
getgenv().Cheat.Options.GunMods = getgenv().Cheat.Options.GunMods or {}

-- Gun mod toggles
getgenv().Cheat.Options.GunMods.NoRecoil = false
getgenv().Cheat.Options.GunMods.NoBobbing = false
getgenv().Cheat.Options.GunMods.NoSway = false
getgenv().Cheat.Options.GunMods.InstantLean = false
getgenv().Cheat.Options.GunMods.NoSprintOffset = false
getgenv().Cheat.Options.GunMods.UnlockFiremodes = false

-- ===== TRACER SETTINGS =====
getgenv().Tracers = false
getgenv().TracerColor1 = Color3.fromRGB(119, 120, 255)
getgenv().TracerColor2 = Color3.fromRGB(255, 255, 255)
getgenv().TracerFadeTime = 0.5
getgenv().TracerMaterial = 'Neon'

-- ===== VIEWMODEL SETTINGS =====
getgenv().viewmodbool = false
getgenv().viewmodhandcolor = Color3.fromRGB(255, 255, 255)
getgenv().viewmodhandmat = Enum.Material.ForceField
getgenv().viewmodguncolor = Color3.fromRGB(0, 0, 0)
getgenv().viewmodgunmat = Enum.Material.Neon

-- ===== REFERENCES =====
local Players = game:GetService("Players")
local Client = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService('RunService')
local GameFramework = {}

--==============================================--
--                GUN MOD HOOKS                --
--==============================================--

local function SetupGameFramework()
    for _, obj in next, getgc(true) do
        if type(obj) == "table" then
            if rawget(obj, "updateClient") then
                GameFramework.FPS = obj
            end
            if rawget(obj, "springs") and rawget(obj.springs, "sway") then
                GameFramework.CurrentData = obj
            end
        end
    end

    if GameFramework.FPS and GameFramework.CurrentData then
        local OldUpdateClient = GameFramework.FPS.updateClient

        GameFramework.FPS.updateClient = function(...)
            local Args = {...}
            local WeaponData = Args[1]
            local Springs = GameFramework.CurrentData.springs

            if Springs then
                if getgenv().Cheat.Options.GunMods.InstantLean then
                    Springs.leanAlpha.Force = 25
                    Springs.leanAlpha.Speed = 50
                end
                if getgenv().Cheat.Options.GunMods.NoBobbing then
                    Springs.jumpTilt.Force = 0
                    Springs.jumpTilt.Speed = 0
                    Springs.walkCycle.Force = 0
                    Springs.walkCycle.Speed = 0
                    Springs.sprintCycle.Force = 0
                    Springs.sprintCycle.Speed = 0
                    Springs.strafeTilt.Force = 0
                    Springs.strafeTilt.Speed = 0
                end
                if getgenv().Cheat.Options.GunMods.NoRecoil then
                    Springs.cameraRecoil.Force = 0
                    Springs.cameraRecoil.Speed = 0
                    Springs.recoilRot.Force = 0
                    Springs.recoilRot.Speed = 0
                end
                if getgenv().Cheat.Options.GunMods.NoSway then
                    Springs.sway.Position = Vector3.new(0,0,0)
                    Springs.sway.Speed = 0
                end
            end

            if WeaponData and getgenv().Cheat.Options.GunMods.UnlockFiremodes and rawget(WeaponData, "FireModes") then
                WeaponData.FireModes = {"Auto", "Semi"}
            end

            return OldUpdateClient(unpack(Args))
        end
    end
end

SetupGameFramework()

Client.CharacterAdded:Connect(function()
    GameFramework.CurrentData = nil
    task.wait(3)
    repeat task.wait() until Client.Character and Client.Character:FindFirstChildOfClass("Humanoid")
    SetupGameFramework()
end)

-- ===== No Sprint Offset =====
local MT = getrawmetatable(game)
setreadonly(MT, false)
local OldNamecall = MT.__namecall

MT.__namecall = newcclosure(function(self, ...)
    local Args = {...}
    local Method = getnamecallmethod()

    if Method == "GetAttribute" and self.Name == "Sprinting" and Args[1] == "Value" then
        if getgenv().Cheat.Options.GunMods.NoSprintOffset then
            return false
        end
    end

    return OldNamecall(self, ...)
end)
setreadonly(MT, true)

--==============================================--
--               TRACER SYSTEM                  --
--==============================================--

local RS = ReplicatedStorage
local BulletModule = require(RS.Modules.FPS.Bullet)
local oldCreate = BulletModule.CreateBullet

local function fade(part)
    task.spawn(function()
        local steps = 20
        local delay = getgenv().TracerFadeTime / steps

        for i = 1, steps do
            part.Transparency = i / steps
            task.wait(delay)
        end

        part:Destroy()
    end)
end

local function makeTracer(fromPos, toPos)
    if not getgenv().Tracers then return end

    local dist = (toPos - fromPos).Magnitude
    local mid = (fromPos + toPos) / 2

    local tracer = Instance.new('Part')
    tracer.Anchored = true
    tracer.CanCollide = false
    tracer.Size = Vector3.new(0.1, 0.1, dist)
    tracer.CFrame = CFrame.new(fromPos, toPos) * CFrame.new(0, 0, -dist / 2)
    tracer.Material = (getgenv().TracerMaterial == 'ForceField' and Enum.Material.ForceField or Enum.Material.Neon)
    tracer.Color = getgenv().TracerColor1
    tracer.Parent = workspace

    local tracer2 = Instance.new('Part')
    tracer2.Anchored = true
    tracer2.CanCollide = false
    tracer2.Size = Vector3.new(0.12, 0.12, dist * 0.5)
    tracer2.CFrame = CFrame.new(mid, toPos)
    tracer2.Material = tracer.Material
    tracer2.Color = getgenv().TracerColor2
    tracer2.Transparency = 0.2
    tracer2.Parent = workspace

    fade(tracer)
    fade(tracer2)
end

BulletModule.CreateBullet = function(...)
    local args = {...}
    local data = args[5]

    if data and data.CFrame then
        local origin = data.CFrame.Position
        local target = origin + data.CFrame.LookVector * 2000
        makeTracer(origin, target)
    end

    return oldCreate(...)
end

--==============================================--
--              VIEWMODEL SYSTEM                --
--==============================================--

local wcamera = workspace.CurrentCamera

local function handleViewModel()
    if getgenv().viewmodbool and wcamera:FindFirstChild('ViewModel') then
        for _, obj in pairs(wcamera.ViewModel:GetDescendants()) do
            if obj:IsA('BasePart') then
                local mb = obj:FindFirstChildOfClass('SurfaceAppearance')
                if mb then mb:Destroy() end

                if not obj:FindFirstAncestor('Item') then
                    obj.Color = getgenv().viewmodhandcolor
                    obj.Material = getgenv().viewmodhandmat
                else
                    obj.Color = getgenv().viewmodguncolor
                    obj.Material = getgenv().viewmodgunmat
                end

            elseif obj:IsA('Model') and obj:FindFirstChild('LL') then
                obj:Destroy()
            end
        end
    end
end

RunService.RenderStepped:Connect(function()
    handleViewModel()
end)

print('[Combined Gun Mods + Tracer + ViewModel Loaded]')
